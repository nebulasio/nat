<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pledge All Test</title>
    <script type="text/javascript" src="libs/nebulas.js"></script>
    <script type="text/javascript" src="libs/neblocal.js"></script>
    <script type="text/javascript" src="../contracts/nat.js"></script>
    <script type="text/javascript" src="../contracts/pledge_proxy.js"></script>
    <script type="text/javascript" src="../contracts/distribute.js"></script>
    <script type="text/javascript" src="../contracts/pledge.js"></script>
    <script type="text/javascript" src="../contracts/nr_data.js"></script>
    <script type="text/javascript">
        localStorage.clear();

        let natAddress = "  n1zUNqeBPvsyrw5zxp9mKcDdLTjuaEL7s39";

        let pledgeAddress = "n1F5VUpUfUbnVksQWcQcAvbY9K9dbakAvpN";
        let prevPledgeAddress = "n1v4M6kpPLMBnPe48z7EmGF8uP7TZ9un8ez";
        let proxyAddress = "n1d6YyHs2eL7pE3RKFbxCWcd2ExYx1MAXgF";
        let distributeAddress = "n1cwsE8w4m6cRkr14R5c4hK3Lb9wPsUHhY9";
        let nrDataAddress = "n1keX3piVEzAc14MthT25Cg6hFFSw76Msja";
        let voteAddress = "n1LJuxRULaTUNHGjGQSfnBNjSixqXyvuPU4";

        let multiSignAddress = "n1Z6MhSZa321SnpiKfUWiybQSG3GCmRHunv";
        let customerAddress = "n1YPMjEDMrZhroKmB1xDBhadygwWHC4zTwm";

        let fundManagerAddress = "n1XpqPVnskUP1nzRoVZ9pvQ3P6yQJgfG8qc";

        let unit = new BigNumber(10).pow(18);

        function initContext() {
            BlockchainTool.transfer(null, customerAddress, new BigNumber(1000).mul(unit));
            BlockchainTool.registerContract(proxyAddress, PledgeProxy);
            BlockchainTool.registerContract(distributeAddress, Distribute);
            BlockchainTool.registerContract(pledgeAddress, Pledge);
            BlockchainTool.registerContract(natAddress, NATToken);
            BlockchainTool.registerContract(nrDataAddress, NrDataSource);
        }

        function initContractTest() {
            // Pledge
            BlockchainTool.callContract(customerAddress, pledgeAddress, 0, "init", [multiSignAddress]);

            // Proxy
            BlockchainTool.callContract(customerAddress, proxyAddress, 0, "init", [multiSignAddress]);

            // Distribute
            BlockchainTool.callContract(customerAddress, distributeAddress, 0, "init", [1, multiSignAddress]);
        }

        function updateConfigTest() {
            // Pledge
            //                          caller              callee      value   func            parmas
            BlockchainTool.callContract(multiSignAddress, pledgeAddress, 0, "setConfig", [{
                multiSign: multiSignAddress,
                pledgeProxy: proxyAddress,
                distribute: distributeAddress,
                prevPledge: prevPledgeAddress
            }]);

            // Proxy
            BlockchainTool.callContract(multiSignAddress, proxyAddress, 0, "setConfig", [{
                multiSign: multiSignAddress,
                pledge: pledgeAddress,
                fundManager: fundManagerAddress,
            }]);

            // Distribute
            BlockchainTool.callContract(multiSignAddress, distributeAddress, 0, "setConfig", [{
                nat: natAddress,
                pledge: pledgeAddress,
                vote: voteAddress,
                nr: nrDataAddress
            }]);
        }

        function balance(address) {
            return BlockchainTool.getBalance(address).div(unit).toString(10);
        }

        function pledgeTest() {
            console.log("--------------------\nPledge Test");
            console.log("customer amount:" + balance(customerAddress));
            console.log("proxy amount:" + balance(proxyAddress));

            let amount = new BigNumber("5").mul(unit);
            BlockchainTool.callContract(customerAddress, proxyAddress, amount, "pledge", []);

            console.log("customer amount 1:" + balance(customerAddress));
            console.log("proxy amount 1:" + balance(proxyAddress));
            console.log("--------------------");
        }

        function cancelPledgeTest() {
            console.log("--------------------\nCancel Pledge Test");
            console.log("customer amount:" + balance(customerAddress));
            console.log("proxy amount 1:" + balance(proxyAddress));

            BlockchainTool.callContract(customerAddress, proxyAddress, 0, "cancelPledge", []);

            console.log("customer amount 1:" + balance(customerAddress));
            console.log("proxy amount 1:" + balance(proxyAddress));
            console.log("--------------------");
        }

        function main() {
            // try {
            initContext();
            initContractTest();
            updateConfigTest();

            BlockchainTool.blockHeight = 0;
            pledgeTest();
            BlockchainTool.blockHeight = 101;
            cancelPledgeTest();
            // } catch (e) {
            //     alert(e)
            // }
        }

        main();
    </script>
</head>

<body>
</body>
</html>
