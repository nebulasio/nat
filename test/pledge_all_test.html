<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pledge All Test</title>
    <script type="text/javascript" src="libs/nebulas.js"></script>
    <script type="text/javascript" src="libs/neblocal.js"></script>
    <script type="text/javascript" src="../contracts/nat.js"></script>
    <script type="text/javascript" src="../contracts/multisig.js"></script>
    <script type="text/javascript" src="../contracts/pledge_proxy.js"></script>
    <script type="text/javascript" src="../contracts/distribute.js"></script>
    <script type="text/javascript" src="../contracts/pledge.js"></script>
    <script type="text/javascript" src="../contracts/nr_data.js"></script>
    <script type="text/javascript">
        localStorage.clear();


        let natAddress = "n1zUNqeBPvsyrw5zxp9mKcDdLTjuaEL7s39";

        let pledgeAddress = "n1F5VUpUfUbnVksQWcQcAvbY9K9dbakAvpN";
        let prevPledgeAddress = "n1v4M6kpPLMBnPe48z7EmGF8uP7TZ9un8ez";
        let proxyAddress = "n1d6YyHs2eL7pE3RKFbxCWcd2ExYx1MAXgF";
        let distributeAddress = "n1cwsE8w4m6cRkr14R5c4hK3Lb9wPsUHhY9";
        let distributeVoteTaxAddrv = "n1Xz96gDHrrs4ymBgpirav6LbFxZ1p5aRL1";
        let distributeManageAddress = "n1Jc4mkpbvLeGFq4LMzAx5f5dK4pKHEUUDb";
        let nrDataAddress = "n1keX3piVEzAc14MthT25Cg6hFFSw76Msja";
        let nrDataManager = "n1NznNCpYvuWdXBBbj1CSZn8huAPkQHM9t2";
        let voteAddress = "n1LJuxRULaTUNHGjGQSfnBNjSixqXyvuPU4";

        let multiSignAddress = "n1Z6MhSZa321SnpiKfUWiybQSG3GCmRHunv";
        let customerAddress = "n1YPMjEDMrZhroKmB1xDBhadygwWHC4zTwm";

        let proxyManagerAddress = "n1XpqPVnskUP1nzRoVZ9pvQ3P6yQJgfG8qc";
        let coSignerAddress = ["n1YkXBfHqaGXBYmi3d3L65ECLLzfRResX5n", "n1b2yNRseEaZmvZqoc2mHEtyiteoKVCnJPY"]; 
        let blacklist = ["n1XXoWQaucXCNew4cYUhzXzPKAXAQzRPbvt", "n1HYTU3v2zZeMdBPKor3ow1YhoEPNs5EgQ8", "n1NMVvLQxvkH3zkFu53Siz4xsw4kC2Z6g1v"];

        let multiSigConfig = { 
            natConfig:
                {
                    multiSig: multiSignAddress,
                    distribute: distributeAddress,
                    distributeVoteTaxAddrv: distributeVoteTaxAddrv,
                    distributeManager: null,
                    pledgeProxy: proxyAddress,
                    pledgeProxyManager: proxyManagerAddress,
                    pledge: pledgeAddress,
                    nrData: nrDataAddress,
                    nrDataManager: nrDataManager,
                    natNRC20: natAddress,
                    vote:voteAddress,
                },
            contractList:
                {
                    distribute: distributeAddress, // distribute.js
                    pledge_proxy: proxyAddress, // pledge_proxy.js
                    pledge: pledgeAddress, // pledge.js
                    //nr_data: nrDataAddress, // nr_data.js
                    nat_nrc20: natAddress, // nat_nrc20.js
                    //vote: voteAddress,    // vote.js
                }
            };

        let unit = new BigNumber(10).pow(18);

        function initContext() {
            BlockchainTool.transfer(null, customerAddress, new BigNumber(1000).mul(unit));
            BlockchainTool.transfer(null, coSignerAddress[0], new BigNumber(1000).mul(unit));
            BlockchainTool.transfer(null, coSignerAddress[1], new BigNumber(1000).mul(unit));

            BlockchainTool.registerContract(proxyAddress, PledgeProxy);
            BlockchainTool.registerContract(distributeAddress, Distribute);
            BlockchainTool.registerContract(pledgeAddress, Pledge);
            BlockchainTool.registerContract(natAddress, NATToken);
            BlockchainTool.registerContract(nrDataAddress, NrDataSource);
            BlockchainTool.registerContract(multiSignAddress, MultiSig);
            //BlockchainTool.registerContract(voteAddress, Vote);
        }

        function initContractTest() {
            // multisig
            BlockchainTool.callContract(customerAddress, multiSignAddress, 0, "init", [coSignerAddress]);

            // Pledge
            BlockchainTool.callContract(customerAddress, pledgeAddress, 0, "init", [multiSignAddress]);

            // Proxy
            BlockchainTool.callContract(customerAddress, proxyAddress, 0, "init", [multiSignAddress]);

            // Distribute
            BlockchainTool.callContract(customerAddress, distributeAddress, 0, "init", [1, multiSignAddress]);

            // NAT
            BlockchainTool.callContract(customerAddress, natAddress, 0, "init", ["NAT", "NAT", 18, multiSignAddress]);
        }

        function updateConfigTest() {
            // Multisig
            BlockchainTool.callContract(coSignerAddress[0], multiSignAddress, 0, "setConfig", [multiSigConfig]);

            // Get config
            let config = BlockchainTool.callContract(coSignerAddress[1], multiSignAddress, 0, "getConfig", []);
            console.log(config);
        }

        function multisigTest() {
            // getCosigners
            let cosigners = BlockchainTool.callContract(coSignerAddress[0], multiSignAddress, 0, "getCosigners", []);
            console.log("cosigners", cosigners);

            BlockchainTool.callContract(coSignerAddress[0], multiSignAddress, 0, "setNRBlacklist", [blacklist]);
            let list = BlockchainTool.callContract(coSignerAddress[0], multiSignAddress, 0, "getNRBlacklist", []);
            console.log("blacklist", list);
        }

        function balance(address) {
            return BlockchainTool.getBalance(address).div(unit).toString(10);
        }

        function pledgeProxyTest() {
            BlockchainTool.callContract(proxyManagerAddress, proxyAddress, 0, "geiiitCosigners", []);
        } 

        function pledgeTest() {
            console.log("-------------------------------------------\nPledge Test");
            console.log("customer amount:" + balance(customerAddress));
            console.log("proxy amount:" + balance(proxyAddress));

            let amount = new BigNumber("5").mul(unit);
            BlockchainTool.callContract(customerAddress, proxyAddress, amount, "pledge", []);

            console.log("customer amount 1:" + balance(customerAddress));
            console.log("proxy amount 1:" + balance(proxyAddress));
        }

        function cancelPledgeTest() {
            console.log("-------------------------------------------\nCancel Pledge Test");
            console.log("customer amount:" + balance(customerAddress));
            console.log("proxy amount:" + balance(proxyAddress));

            BlockchainTool.callContract(customerAddress, proxyAddress, 0, "cancelPledge", []);

            console.log("customer amount 1:" + balance(customerAddress));
            console.log("proxy amount 1:" + balance(proxyAddress));
        }

        function getCurrentPledgesTest() {
            console.log("-------------------------------------------\nGet Current Pledges Test");

            // BlockchainTool.callContract(customerAddress, proxyAddress, 0, "cancelPledge", []);
            let r = BlockchainTool.callContract(customerAddress, proxyAddress, 0, "getCurrentPledges", [customerAddress]);

            console.log("pledges:\n" + JSON.stringify(r));
        }

        function getPledgeAddressIndexesTest() {
            console.log("-------------------------------------------\nGet Pledge Address Indexes Test");

            let r = BlockchainTool.callContract(customerAddress, proxyAddress, 0, "getAddressIndexes", []);

            console.log("indexes:\n" + JSON.stringify(r));
        }

        function getPledgeAddressesTest() {
            console.log("-------------------------------------------\nGet Pledge Addresses Test");

            let r = BlockchainTool.callContract(customerAddress, proxyAddress, 0, "getAddresses", [0]);

            console.log("addresses:\n" + JSON.stringify(r));
        }

        function getHistoryPledgesTest() {
            console.log("-------------------------------------------\nGet History Pledges Test");

            let r = BlockchainTool.callContract(customerAddress, proxyAddress, 0, "getHistoryPledges", [customerAddress, 0]);

            console.log("histories:\n" + JSON.stringify(r));
        }

        function getPledgeDistributesTest() {
            console.log("-------------------------------------------\nGet Pledge Distributes Test");

            let r = BlockchainTool.callContract(customerAddress, proxyAddress, 0, "getDistributes", [customerAddress, 0]);

            console.log("distributes:\n" + JSON.stringify(r));
        }

        function distributeTest() {
            let r = BlockchainTool.callContract(multiSignAddress, distributeAddress, 0, "triggerPledge", []);
        }

        function main() {
            initContext();
            initContractTest();
            updateConfigTest();

            multisigTest();
            getCurrentPledgesTest();
            getPledgeAddressesTest();

            BlockchainTool.blockHeight = 0;
            pledgeTest();

            getCurrentPledgesTest();

            BlockchainTool.blockHeight = 101;
            cancelPledgeTest();

            getCurrentPledgesTest();
            getPledgeAddressIndexesTest();
            getPledgeAddressesTest();

            BlockchainTool.blockHeight = 201;
            distributeTest();

            getHistoryPledgesTest();
            getPledgeDistributesTest();

        }

        main();
    </script>
</head>

<body>
</body>
</html>
