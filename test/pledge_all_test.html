<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pledge All Test</title>
    <script type="text/javascript" src="libs/nebulas.js"></script>
    <script type="text/javascript" src="libs/neblocal.js"></script>
    <script type="text/javascript" src="../contracts/nat.js"></script>
    <script type="text/javascript" src="../contracts/multisig.js"></script>
    <script type="text/javascript" src="../contracts/pledge_proxy.js"></script>
    <script type="text/javascript" src="../contracts/distribute.js"></script>
    <script type="text/javascript" src="../contracts/pledge.js"></script>
    <script type="text/javascript" src="../contracts/nr_data.js"></script>
    <script type="text/javascript">
        localStorage.clear();

        let natAddress = "n1zUNqeBPvsyrw5zxp9mKcDdLTjuaEL7s39";

        let pledgeAddress = "n1F5VUpUfUbnVksQWcQcAvbY9K9dbakAvpN";
        let prevPledgeAddress = "n1n5Fctkjx2pA7iLX8rgRyCa7VKinGFNe9H";
        let proxyAddress = "n1d6YyHs2eL7pE3RKFbxCWcd2ExYx1MAXgF";
        let distributeAddress = "n1cwsE8w4m6cRkr14R5c4hK3Lb9wPsUHhY9";
        let distributeVoteTaxAddrv = "n1Xz96gDHrrs4ymBgpirav6LbFxZ1p5aRL1";
        let distributeManageAddress = "n1Jc4mkpbvLeGFq4LMzAx5f5dK4pKHEUUDb";
        let nrDataAddress = "n1keX3piVEzAc14MthT25Cg6hFFSw76Msja";
        let nrDataManager = "n1NznNCpYvuWdXBBbj1CSZn8huAPkQHM9t2";
        let voteAddress = "n1LJuxRULaTUNHGjGQSfnBNjSixqXyvuPU4";

        let multiSignAddress = "n1Z6MhSZa321SnpiKfUWiybQSG3GCmRHunv";
        let customerAddress = "n1YPMjEDMrZhroKmB1xDBhadygwWHC4zTwm";
        let customerAddress1 = "n1JuGuSaa92L9eZkaL51UHVVeC1u57yTkR8";

        let proxyManagerAddress = "n1XpqPVnskUP1nzRoVZ9pvQ3P6yQJgfG8qc";
        let coSignerAddress = ["n1YkXBfHqaGXBYmi3d3L65ECLLzfRResX5n", "n1b2yNRseEaZmvZqoc2mHEtyiteoKVCnJPY"];
        let blacklist = ["n1XXoWQaucXCNew4cYUhzXzPKAXAQzRPbvt", "n1HYTU3v2zZeMdBPKor3ow1YhoEPNs5EgQ8", "n1NMVvLQxvkH3zkFu53Siz4xsw4kC2Z6g1v"];

        let multiSigConfig = {
            natConfig: {
                multiSig: multiSignAddress,
                distribute: distributeAddress,
                distributeVoteTaxAddrv: distributeVoteTaxAddrv,
                distributeManager: distributeManageAddress,
                pledgeProxy: proxyAddress,
                pledgeProxyManager: proxyManagerAddress,
                pledge: pledgeAddress,
                nrData: nrDataAddress,
                nrDataManager: nrDataManager,
                natNRC20: natAddress,
                vote: voteAddress,
            },
            contractList: {
                distribute: distributeAddress, // distribute.js
                pledge_proxy: proxyAddress, // pledge_proxy.js
                pledge: pledgeAddress, // pledge.js
                nr_data: nrDataAddress, // nr_data.js
                nat_nrc20: natAddress, // nat_nrc20.js
                //vote: voteAddress,    // vote.js
            }
        };

        let unit = new BigNumber(10).pow(18);

        function balance(address) {
            return BlockchainTool.getBalance(address).div(unit).toString(10);
        }

        function log(space, data) {
            let array = data.split("\n");
            let prefix = "";
            for (let i = 0; i < space; ++i) {
                prefix += " ";
            }
            for (let i = 0; i < array.length; ++i) {
                console.log(prefix + array[i]);
            }
        }

        function initContext() {
            BlockchainTool.transfer(null, customerAddress, new BigNumber(1000).mul(unit));
            BlockchainTool.transfer(null, customerAddress1, new BigNumber(1000).mul(unit));
            BlockchainTool.transfer(null, coSignerAddress[0], new BigNumber(1000).mul(unit));
            BlockchainTool.transfer(null, coSignerAddress[1], new BigNumber(1000).mul(unit));

            BlockchainTool.registerContract(proxyAddress, PledgeProxy);
            BlockchainTool.registerContract(distributeAddress, Distribute);
            BlockchainTool.registerContract(pledgeAddress, Pledge);
            BlockchainTool.registerContract(natAddress, NATToken);
            BlockchainTool.registerContract(nrDataAddress, NrDataSource);
            BlockchainTool.registerContract(multiSignAddress, MultiSig);
            //BlockchainTool.registerContract(voteAddress, Vote);
        }

        function initContractTest() {
            // multisig
            BlockchainTool.callContract(customerAddress, multiSignAddress, 0, "init", [coSignerAddress]);

            // Pledge
            BlockchainTool.callContract(customerAddress, pledgeAddress, 0, "init", [multiSignAddress]);

            // Proxy
            BlockchainTool.callContract(customerAddress, proxyAddress, 0, "init", [multiSignAddress]);

            // Distribute
            BlockchainTool.callContract(customerAddress, distributeAddress, 0, "init", [0, multiSignAddress]);

            // NAT
            BlockchainTool.callContract(customerAddress, natAddress, 0, "init", ["NAT", "NAT", 18, multiSignAddress]);
        }

        function updateConfigTest() {
            // Multisig
            BlockchainTool.callContract(coSignerAddress[0], multiSignAddress, 0, "setConfig", [multiSigConfig]);

            // Get config
            let config = BlockchainTool.callContract(coSignerAddress[1], multiSignAddress, 0, "getConfig", []);
            console.log(config);
        }

        function multisigTest() {
            // getCosigners
            let cosigners = BlockchainTool.callContract(coSignerAddress[0], multiSignAddress, 0, "getCosigners", []);
            console.log("cosigners", cosigners);

            BlockchainTool.callContract(coSignerAddress[0], multiSignAddress, 0, "setBlacklist", [blacklist]);
            let list = BlockchainTool.callContract(coSignerAddress[0], multiSignAddress, 0, "getBlacklist", []);
            console.log("blacklist", list);
        }

        function pledgeProxyTest() {
            BlockchainTool.callContract(proxyManagerAddress, proxyAddress, 0, "geiiitCosigners", []);
        }


        function uploadOnePageNrData(startBlock, endBlock, count, startIndex, addresses) {
            let data = {
                startHeight: startBlock,
                endHeight: endBlock,
                count: count,
                startIndex: startIndex,
                data: addresses
            };
            let r = BlockchainTool.callContract(nrDataManager, nrDataAddress, 0, "upload", [data]);
            log(0, "upload:" + JSON.stringify(data) + "\nresult:" + JSON.stringify(r));
        }

        function uploadNrData() {
            uploadOnePageNrData(1, 100, 3, 0, [customerAddress, customerAddress1, multiSignAddress]);
            BlockchainTool.resetNr();
            uploadOnePageNrData(101, 200, 2, 0, [customerAddress, customerAddress1, multiSignAddress]);
            uploadOnePageNrData(101, 200, 2, 0, [customerAddress, customerAddress1]);
        }

        function nrDataTest() {
            console.log("-------------------------------------------\nNrDataSource Test");

            uploadNrData();

            let indexes = BlockchainTool.callContract(nrDataManager, nrDataAddress, 0, "getCycleIndexes", []);
            log(0, "getCycleIndexes:\n" + JSON.stringify(indexes));
            for (let i = 0; i < indexes.length; ++i) {
                let index = indexes[i];
                let cycles = BlockchainTool.callContract(nrDataManager, nrDataAddress, 0, "getCycles", [index.i]);
                log(2, "getCyclesWithIndex:" + JSON.stringify(index) + "\ncycles:\n" + JSON.stringify(cycles));
                for (let j = 0; j < cycles.length; ++j) {
                    let c = cycles[j];
                    let cis = BlockchainTool.callContract(nrDataManager, nrDataAddress, 0, "getNRIndexesWithCycle", [c.startHeight, c.endHeight]);
                    log(4, "getNRIndexesWithCycle:" + JSON.stringify(c) + "\nindexes:\n" + JSON.stringify(cis));
                    for (let k = 0; k < cis.length; ++k) {
                        let nrs = BlockchainTool.callContract(nrDataManager, nrDataAddress, 0, "getNRWithCycle", [c.startHeight, c.endHeight, cis[k].i]);
                        log(6, "getNRWithCycle:" + JSON.stringify(c) + " index:" + JSON.stringify(cis[k]) + "\nnrs:\n" + JSON.stringify(nrs));
                    }
                }
            }
        }

        function pledge(customerAddress, amount) {
            log(0, "***Pledge Address:" + customerAddress);
            log(0, "before:\ncustomer amount:" + balance(customerAddress) + " proxy amount:" + balance(proxyAddress));
            let a = new BigNumber(amount).mul(unit);
            BlockchainTool.callContract(customerAddress, proxyAddress, a, "pledge", []);
            log(0, "after:\ncustomer amount:" + balance(customerAddress) + " proxy amount:" + balance(proxyAddress));
        }

        function cancelPledge(customerAddress) {
            log(0, "*** Cancel Pledge Address:" + customerAddress);
            log(0, "before:\ncustomer amount:" + balance(customerAddress) + " proxy amount:" + balance(proxyAddress));
            BlockchainTool.callContract(customerAddress, proxyAddress, 0, "cancelPledge", []);
            log(0, "after:\ncustomer amount:" + balance(customerAddress) + " proxy amount:" + balance(proxyAddress));
        }

        function pledgeTest() {
            log(0, "-------------------------------------------\nPledge Test");
            pledge(customerAddress, 5.6);
            pledge(customerAddress1, 108.111);
        }

        function cancelPledgeTest() {
            log(0, "-------------------------------------------\nCancel Pledge Test");
            cancelPledge(customerAddress);
            cancelPledge(customerAddress1);
        }


        function printAddressPledgeData(address) {
            log(2, "****Address: " + address);
            let r = BlockchainTool.callContract(customerAddress, proxyAddress, 0, "getCurrentPledges", [address]);
            log(2, "getCurrentPledges:\n" + JSON.stringify(r));

            let indexes = BlockchainTool.callContract(customerAddress, proxyAddress, 0, "getHistoryPledgeIndexes", [address]);
            log(2, "getHistoryPledgeIndexes:\n" + JSON.stringify(indexes));

            for (let i = 0; i < indexes.length; ++i) {
                r = BlockchainTool.callContract(customerAddress, proxyAddress, 0, "getHistoryPledges", [address, indexes[i].i]);
                log(4, "getHistoryPledgesWithIndex:" + JSON.stringify(indexes[i]) + "\nhistoryPledges:\n" + JSON.stringify(r));
            }

            indexes = BlockchainTool.callContract(customerAddress, proxyAddress, 0, "getDistributeIndexes", [address]);
            log(2, "getDistributeIndexes:\n" + JSON.stringify(indexes));

            for (let i = 0; i < indexes.length; ++i) {
                r = BlockchainTool.callContract(customerAddress, proxyAddress, 0, "getDistributes", [address, indexes[i].i]);
                log(4, "getDistributesWithIndex:" + JSON.stringify(indexes[i]) + "\ndistributes:\n" + JSON.stringify(r));
            }

            r = BlockchainTool.callContract(customerAddress, proxyAddress, 0, "getTotalDistribute", [address]);
            log(2, "getTotalDistribute: " + r);
        }

        function getPledgeDataTest() {
            log(0, "-------------------------------------------\nGet Pledge Data Test");

            let indexes = BlockchainTool.callContract(customerAddress, proxyAddress, 0, "getAddressIndexes", []);
            log(0, "getAddressIndexes:\n" + JSON.stringify(indexes));

            for (let i = 0; i < indexes.length; ++i) {
                let r = BlockchainTool.callContract(customerAddress, proxyAddress, 0, "getAddresses", [indexes[i].i]);
                log(2, "getAddressesWithIndex:" + JSON.stringify(indexes[i]) + "\naddresses:\n" + JSON.stringify(r));
                for (let j = 0; j < r.length; ++j) {
                    printAddressPledgeData(r[j]);
                }
            }
        }


        function triggerPledge() {
            try {
                let r = BlockchainTool.callContract(distributeManageAddress, distributeAddress, 0, "triggerPledge", []);
                console.log(JSON.stringify(r));
                if (r.needTrigger) {
                    triggerPledge();
                }
            } catch (e) {
                log(0, "error: " + e);
            }
        }

        function triggerNR() {
            try {
                let r = BlockchainTool.callContract(distributeManageAddress, distributeAddress, 0, "triggerNR", []);
                console.log(JSON.stringify(r));
                if (r.needTrigger) {
                    triggerNR();
                }
            } catch (e) {
                log(0, "error: " + e);
            }
        }

        function distributeTest() {
            console.log("-------------------------------------------\nDistribute Test");

            console.log("*** Trigger Pledge");
            triggerPledge();
            console.log("*** Trigger Pledge");
            triggerPledge();
            console.log("*** Trigger Pledge");
            triggerPledge();

            console.log("*** Trigger NR");
            triggerNR();
            console.log("*** Trigger NR");
            triggerNR();
            console.log("*** Trigger NR");
            triggerNR();
        }


        function getNatBalance(address) {
            log(0, "*** Get Nat Balance, Address: " + address);

            let r = BlockchainTool.callContract(customerAddress, natAddress, 0, "balanceOf", [address]);
            r = new BigNumber(r).div(unit).toString(10);
            log(0, "balance: " + r);
        }

        function natBalanceTest() {
            console.log("-------------------------------------------\nNat Balance Test");
            getNatBalance(customerAddress);
            getNatBalance(customerAddress1);
        }


        function main() {
            initContext();
            initContractTest();
            updateConfigTest();

            multisigTest();

            getPledgeDataTest();

            nrDataTest();

            BlockchainTool.blockHeight = 0;
            pledgeTest();

            getPledgeDataTest();

            BlockchainTool.blockHeight = 101;
            cancelPledgeTest();

            getPledgeDataTest();

            BlockchainTool.blockHeight = 201;
            distributeTest();

            getPledgeDataTest();

            natBalanceTest();
        }

        main();
    </script>
</head>

<body>
</body>
</html>
