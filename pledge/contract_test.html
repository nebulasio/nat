<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pledge Contract Test</title>
    <script type="text/javascript" src="../libs/nebulas.js"></script>
    <script type="text/javascript" src="../neb_context.js"></script>
    <script type="text/javascript" src="contract.js"></script>
    <script type="text/javascript" src="test_nat_contract.js"></script>

    <script type="text/javascript">
        localStorage.clear();

        let pledgeContractAddress = "n1mBSJqcvPoiMeLFN9CFxmXsjDNB9bJhm1W";
        let natContractAddress = "n1EvmW3zzu7zmgoez9uvMMGhPzZ5LCdcFRm";

        let managerAddress = "n1Z6MhSZa321SnpiKfUWiybQSG3GCmRHunv";
        let customerAddress = "n1YPMjEDMrZhroKmB1xDBhadygwWHC4zTwm";

        let unit = new BigNumber(10).pow(18);

        BlockchainTool.transfer(null, customerAddress, new BigNumber(1000).mul(unit));

        BlockchainTool.registerContract(pledgeContractAddress, Pledge);
        BlockchainTool.registerContract(natContractAddress, TestNat);

        function saveTest(value, num) {
            BlockchainTool.callContract(customerAddress, pledgeContractAddress, value, "pledge", [num]);
        }

        function stopAndExportTest() {
            BlockchainTool.callContract(managerAddress, pledgeContractAddress, 0, "stopAndExportDataToNat", [natContractAddress]);
        }

        function getPledgeAddressIndexesTest() {
            let r = BlockchainTool.callContract(customerAddress, pledgeContractAddress, 0, "getAddressIndexes", []);
            alert("PledgeAddressIndexes:\n" + JSON.stringify(r));
        }

        function getPledgeAddressesTest() {
            let r = BlockchainTool.callContract(customerAddress, pledgeContractAddress, 0, "getAddresses", [0]);
            alert("PledgeAddresses:\n" + JSON.stringify(r));
        }

        function getPledgesTest() {
            let r = BlockchainTool.callContract(customerAddress, pledgeContractAddress, 0, "getPledgeWithAddress", [customerAddress]);
            alert("Pledges:\n" + JSON.stringify(r));
        }

        function getReceiveAddressIndexesTest() {
            let r = BlockchainTool.callContract(customerAddress, natContractAddress, 0, "getAddressIndexes", []);
            alert("ReceiveAddressIndexes:\n" + JSON.stringify(r));
        }

        function getReceiveAddressesTest() {
            let r = BlockchainTool.callContract(customerAddress, natContractAddress, 0, "getAddresses", [0]);
            alert("ReceiveAddresses:\n" + JSON.stringify(r));
        }

        function getReceivePledgeTest() {
            let r = BlockchainTool.callContract(customerAddress, natContractAddress, 0, "getPledgeWithAddress", [customerAddress]);
            alert("ReceivePledge:\n" + JSON.stringify(r));
        }

        function recyclingTest() {
            BlockchainTool.callContract(customerAddress, natContractAddress, 0, "recycling", []);
            alert(BlockchainTool.getBalance(managerAddress).div(unit).toString(10));
        }

        function main() {
            try {
                saveTest(new BigNumber(2).mul(unit), 1);
                saveTest(new BigNumber(1.52).mul(unit), 2);
                stopAndExportTest();
                getPledgeAddressIndexesTest();
                getPledgeAddressesTest();
                getPledgesTest();
                getReceiveAddressIndexesTest();
                getReceiveAddressesTest();
                getReceivePledgeTest();
                recyclingTest();
            } catch (e) {
                alert(e);
            }
        }

        main();

    </script>
</head>
<body>

</body>
</html>
