<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pledge Contract Test</title>
    <script type="text/javascript" src="../libs/nebulas.js"></script>
    <script type="text/javascript" src="../neb_context.js"></script>
    <script type="text/javascript" src="contract.js"></script>
    <script type="text/javascript" src="test_nat_contract.js"></script>

    <script type="text/javascript">
        localStorage.clear();

        let pledgeContractAddress = "n1mBSJqcvPoiMeLFN9CFxmXsjDNB9bJhm1W";
        let natContractAddress = "n1EvmW3zzu7zmgoez9uvMMGhPzZ5LCdcFRm";

        let managerAddress = "n1Z6MhSZa321SnpiKfUWiybQSG3GCmRHunv";
        let customerAddress = "n1YPMjEDMrZhroKmB1xDBhadygwWHC4zTwm";

        BlockchainTool.transfer(null, customerAddress, new BigNumber(1000).mul(new BigNumber(10).pow(18)));

        BlockchainTool.registerContract(pledgeContractAddress, Pledge);
        BlockchainTool.registerContract(natContractAddress, TestNat);

        function saveTest(value, num) {
            BlockchainTool.callContract(customerAddress, pledgeContractAddress, value, "pledge", [num]);
        }

        function stopTest() {
            BlockchainTool.callContract(managerAddress, pledgeContractAddress, 0, "stop", []);
        }

        function exportTest() {
            BlockchainTool.callContract(managerAddress, pledgeContractAddress, 0, "exportDataToNat", [natContractAddress]);
        }

        function getPledgesTest() {
            let r = BlockchainTool.callContract(customerAddress, pledgeContractAddress, 0, "getPledgeWithAddress", [customerAddress]);
            alert(JSON.stringify(r));
        }

        function getReceiveAddressesTest() {
            let r = BlockchainTool.callContract(customerAddress, natContractAddress, 0, "getAddresses", [0]);
            alert(JSON.stringify(r));
        }

        function getReceivePledgeTest() {
            let r = BlockchainTool.callContract(customerAddress, natContractAddress, 0, "getPledgeWithAddress", [customerAddress]);
            alert(JSON.stringify(r));
        }

        function recyclingTest() {
            BlockchainTool.callContract(customerAddress, natContractAddress, 0, "recycling", []);
            alert(BlockchainTool.getBalance(managerAddress).div(new BigNumber(10).pow(18)).toString(10));
        }

        function main() {
            try {
                saveTest(new BigNumber(2).mul(new BigNumber(10).pow(18)), 1);
                saveTest(new BigNumber(1.52).mul(new BigNumber(10).pow(18)), 1);
                stopTest();
                exportTest();
                getPledgesTest();
                getReceiveAddressesTest();
                getReceivePledgeTest();
                recyclingTest();
            } catch (e) {
                alert(e);
            }
        }

        main();

    </script>
</head>
<body>

</body>
</html>
